import cv2
from ultralytics import YOLO

# Load a pre-trained YOLOv8 model 
# Note: You would typically fine-tune this on a dataset of firecrackers/smoke
model = YOLO('yolov8n.pt') 

def run_anti_firecracker_hud():
    cap = cv2.VideoCapture(0)  # Open webcam
    
    while cap.isOpened():
        ret, frame = cap.read()
        if not ret: break

        # Run detection
        results = model(frame, stream=True)
        
        # --- HUD OVERLAY ---
        cv2.putText(frame, "SYSTEM: ACTIVE", (20, 40), 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        cv2.putText(frame, "SCANNING FOR EXPLOSIVES...", (20, 70), 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 255), 1)

        for r in results:
            for box in r.boxes:
                # Get coordinates
                x1, y1, x2, y2 = map(int, box.xyxy[0])
                conf = float(box.conf[0])
                
                # Logic: If confidence is high, trigger alarm
                if conf > 0.5:
                    # Draw HUD box
                    cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 3)
                    cv2.putText(frame, f"THREAT: FIRECRACKER {conf:.2f}", (x1, y1-10), 
                                cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 255), 2)
                    
                    # Alert Instance
                    print("[ALERT] Firecracker instance detected!")

        cv2.imshow("Anti-Firecracker AI - HUD Mode", frame)
        
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()

if __name__ == "__main__":
    run_anti_firecracker_hud()



import cv2
import numpy as np
import threading
import pyaudio
import time
from ultralytics import YOLO

# --- CONFIGURATION ---
MODEL_PATH = 'yolov8n.pt'  # Recommended: Use a custom-trained 'firecracker.pt'
AUDIO_THRESHOLD = 0.5      # Sensitivity for acoustic spikes
FRAME_WIDTH, FRAME_HEIGHT = 1280, 720

class AntiFirecrackerHUD:
    def __init__(self):
        self.model = YOLO(MODEL_PATH)
        self.audio_level = 0
        self.alert_active = False
        self.incident_log = []
        self.running = True

    def audio_listener(self):
        """Monitors audio input for sudden high-decibel transients."""
        p = pyaudio.PyAudio()
        stream = p.open(format=pyaudio.paInt16, channels=1, rate=44100,
                        input=True, frames_per_buffer=1024)
        while self.running:
            data = np.frombuffer(stream.read(1024, exception_on_overflow=False), dtype=np.int16)
            self.audio_level = np.abs(data).mean() / 5000.0  # Normalized level
            if self.audio_level > AUDIO_THRESHOLD:
                self.alert_active = True
                self.incident_log.append(f"[{time.strftime('%H:%M:%S')}] ACOUSTIC SPIKE")
                time.sleep(1) # Cool-down
                self.alert_active = False

    def draw_hud(self, frame):
        """Renders the Advanced HUD Overlay."""
        # System Status Bar
        cv2.rectangle(frame, (0, 0), (FRAME_WIDTH, 50), (20, 20, 20), -1)
        cv2.putText(frame, "ANTI-FIRECRACKER AI // DEFENSE MODE", (20, 35), 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 0), 2)
        
        # Audio HUD (Level Meter)
        meter_y = 150
        cv2.putText(frame, "ACOUSTIC INTENSITY", (20, meter_y - 10), 0, 0.5, (255, 255, 255), 1)
        level_w = int(self.audio_level * 200)
        cv2.rectangle(frame, (20, meter_y), (220, meter_y + 15), (50, 50, 50), -1)
        color = (0, 255, 255) if self.audio_level < AUDIO_THRESHOLD else (0, 0, 255)
        cv2.rectangle(frame, (20, meter_y), (20 + level_w, meter_y + 15), color, -1)

        # Incident Log Display
        for i, log in enumerate(self.incident_log[-5:]):
            cv2.putText(frame, log, (20, 250 + (i * 25)), 0, 0.5, (0, 200, 255), 1)

        if self.alert_active:
            cv2.putText(frame, "!!! DETONATION ALERT !!!", (450, 350), 
                        cv2.FONT_HERSHEY_SIMPLEX, 1.5, (0, 0, 255), 4)

    def start(self):
        threading.Thread(target=self.audio_listener, daemon=True).start()
        cap = cv2.VideoCapture(0)
        
        while cap.isOpened():
            ret, frame = cap.read()
            if not ret: break
            frame = cv2.resize(frame, (FRAME_WIDTH, FRAME_HEIGHT))

            # Visual Inference
            results = self.model(frame, verbose=False)
            
            for r in results:
                for box in r.boxes:
                    conf = float(box.conf[0])
                    if conf > 0.4:  # Adjust based on training
                        x1, y1, x2, y2 = map(int, box.xyxy[0])
                        # Draw instance box with HUD style corners
                        self.draw_target_box(frame, x1, y1, x2, y2, conf)

            self.draw_hud(frame)
            cv2.imshow("Detection Console", frame)
            if cv2.waitKey(1) & 0xFF == ord('q'): break

        self.running = False
        cap.release()
        cv2.destroyAllWindows()

    def draw_target_box(self, img, x1, y1, x2, y2, conf):
        """Draws a custom HUD-style cornered box."""
        length = 30
        t = 3
        # Corners
        cv2.line(img, (x1, y1), (x1 + length, y1), (0, 255, 0), t)
        cv2.line(img, (x1, y1), (x1, y1 + length), (0, 255, 0), t)
        cv2.line(img, (x2, y1), (x2 - length, y1), (0, 255, 0), t)
        cv2.line(img, (x2, y1), (x2, y1 + length), (0, 255, 0), t)
        cv2.putText(img, f"OBJ_FIREWORK {conf:.2%}", (x1, y1 - 10), 0, 0.5, (0, 255, 0), 1)

if __name__ == "__main__":
    AI = AntiFirecrackerHUD()
    AI.start()
